pipeline {
    agent any

    environment {
        // Your Docker Hub Image Name
        DOCKER_IMAGE = "eranlebovic/backend-api"
        // Creates a unique tag for every build (v1, v2, v3...)
        IMAGE_TAG = "v${BUILD_NUMBER}"
        // The ID we stored in Jenkins Credentials
        DOCKER_CREDS = "docker-hub-credentials"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    dir('apps/backend') {
                        echo "Building ${DOCKER_IMAGE}:${IMAGE_TAG} from apps/backend..."
                        docker.build("${DOCKER_IMAGE}:${IMAGE_TAG}")
                    }
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    docker.withRegistry('', DOCKER_CREDS) {
                        sh "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
                        sh "docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest"
                        sh "docker push ${DOCKER_IMAGE}:latest"
                    }
                }
            }
        }

        // --- NEW GITOPS STAGE ---
        stage('Update Manifest') {
            steps {
                script {
                    // Use the same GitHub credentials we created earlier
                    def GITHUB_CRED_ID = 'github-credentials' 
                    
                    withCredentials([usernamePassword(credentialsId: GITHUB_CRED_ID, passwordVariable: 'GIT_PASS', usernameVariable: 'GIT_USER')]) {
                        
                        sh "git config user.email 'jenkins@example.com'"
                        sh "git config user.name 'Jenkins CI'"
                        
                        // CRITICAL: We go into the BACKEND k8s folder
                        dir('apps/backend/k8s') {
                            
                            // 1. Update the deployment.yaml with the new tag
                            // We look for the image name 'eranlebovic/backend-api' and replace the tag
                            sh "sed -i 's|image: .*/backend-api:.*|image: eranlebovic/backend-api:v${BUILD_NUMBER}|' deployment.yaml"
                            
                            // 2. Commit the change
                            sh """
                                git add deployment.yaml
                                git commit -m 'Update backend image to v${BUILD_NUMBER} [skip ci]'
                            """
                            
                            // 3. Push to GitHub
                            sh "git push https://${GIT_USER}:${GIT_PASS}@github.com/eranlebovic/final_project.git HEAD:main"
                        }
                    }
                }
            }
        }
    }
}
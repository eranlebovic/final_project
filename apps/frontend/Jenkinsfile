pipeline {
    agent any

    environment {
        // Correct image name for your cluster
        DOCKER_IMAGE = "eranlebovic/frontend-ui"
        IMAGE_TAG = "v${BUILD_NUMBER}"
        DOCKER_CREDS = "docker-hub-credentials"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Frontend Image') {
            steps {
                script {
                    dir('apps/frontend') {
                        echo "Building ${DOCKER_IMAGE}:${IMAGE_TAG}..."
                        docker.build("${DOCKER_IMAGE}:${IMAGE_TAG}")
                    }
                }
            }
        }

        stage('Image Scan (Trivy)') {
            steps {
                script {
                    echo "Scanning image ${DOCKER_IMAGE}:${IMAGE_TAG} for vulnerabilities..."
                    sh "trivy image --severity HIGH,CRITICAL --no-progress ${DOCKER_IMAGE}:${IMAGE_TAG}"
                }
            }
        }

        // STEP 1: PUSH THE IMAGE (Do this first!)
        stage('Push to Docker Hub') {
            steps {
                script {
                    docker.withRegistry('', DOCKER_CREDS) {
                        sh "docker push ${DOCKER_IMAGE}:${IMAGE_TAG}"
                        // It is good practice to push 'latest' too
                        sh "docker tag ${DOCKER_IMAGE}:${IMAGE_TAG} ${DOCKER_IMAGE}:latest"
                        sh "docker push ${DOCKER_IMAGE}:latest"
                    }
                }
            }
        }

        stage('Update Manifest') {
            steps {
                script {
                    // This matches the ID we just created in Step 2
                    def GITHUB_CRED_ID = 'github-credentials' 
                    
                    withCredentials([usernamePassword(credentialsId: GITHUB_CRED_ID, passwordVariable: 'GIT_PASS', usernameVariable: 'GIT_USER')]) {
                        
                        sh "git config user.email 'jenkins@example.com'"
                        sh "git config user.name 'Jenkins CI'"
                        
                        dir('apps/frontend/frontend-chart') {
                            // Update the image tag in the yaml file
                            sh "sed -i 's|tag: \".*\"|tag: \"v${BUILD_NUMBER}\"|' values.yaml"
                            
                            // Commit the change
                            sh """
                                git add values.yaml
                                git commit -m 'Update frontend image to v${BUILD_NUMBER} [skip ci]'
                            """
                            
                            // PUSH using the secure token
                            sh "git push https://${GIT_USER}:${GIT_PASS}@github.com/eranlebovic/final_project.git HEAD:main"
                        }
                    }
                }
            }
        }
    }
}
